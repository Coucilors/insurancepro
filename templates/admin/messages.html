{% extends 'admin/base_admin.html' %}

{% block title %}Messages - Admin | InsurancePro{% endblock %}
{% block page_title %}Contact Messages{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-comment-dots" style="margin-right: 10px;"></i>Customer Inquiries</h2>
        <div style="display: flex; gap: 12px;">
            <span style="color: var(--text-light); font-size: 14px; align-self: center;">
                {{ messages|length }} message(s)
            </span>
        </div>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>From</th>
                        <th>Subject</th>
                        <th>Message</th>
                        <th>Received</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for message in messages %}
                    <tr class="{% if not message.is_read %}unread{% endif %}" data-id="{{ message.id }}">
                        <td>
                            {% if message.is_read %}
                                <span class="status-badge active">Read</span>
                            {% else %}
                                <span class="status-badge" style="background: #fef3c7; color: #92400e;">New</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ message.name }}</strong>
                            <br><small style="color: var(--text-light);">{{ message.email }}</small>
                            {% if message.phone %}
                                <br><small style="color: var(--text-light);"><i class="fas fa-phone"></i> {{ message.phone }}</small>
                            {% endif %}
                        </td>
                        <td>{{ message.subject }}</td>
                        <td>
                            <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ message.message }}
                            </div>
                        </td>
                        <td>{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div class="table-actions">
                                <button class="action-btn" title="View Full Message" onclick="viewMessage({{ message.id }}, '{{ message.name|replace("'", "\\'") }}', '{{ message.email }}', '{{ message.subject|replace("'", "\\'") }}', '{{ message.message|replace("'", "\\'")|replace(chr(10), "\\n") }}', '{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if not message.is_read %}
                                <button class="action-btn mark-read" data-id="{{ message.id }}" title="Mark as Read">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 60px; color: var(--text-light);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            No messages yet
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div id="messageModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">
        <div style="padding: 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 18px; font-weight: 700;">Message Details</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-light);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div style="padding: 24px;">
            <div style="margin-bottom: 16px;">
                <label style="font-size: 12px; color: var(--text-light); text-transform: uppercase; font-weight: 600;">From</label>
                <p id="modalName" style="font-size: 16px; font-weight: 600; margin-top: 4px;"></p>
                <p id="modalEmail" style="font-size: 14px; color: var(--text-light);"></p>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="font-size: 12px; color: var(--text-light); text-transform: uppercase; font-weight: 600;">Subject</label>
                <p id="modalSubject" style="font-size: 16px; font-weight: 600; margin-top: 4px;"></p>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="font-size: 12px; color: var(--text-light); text-transform: uppercase; font-weight: 600;">Received</label>
                <p id="modalDate" style="font-size: 14px; color: var(--text-light); margin-top: 4px;"></p>
            </div>
            <div>
                <label style="font-size: 12px; color: var(--text-light); text-transform: uppercase; font-weight: 600;">Message</label>
                <div id="modalMessage" style="margin-top: 8px; padding: 16px; background: #f8fafc; border-radius: 8px; line-height: 1.7; white-space: pre-wrap;"></div>
            </div>
        </div>
        <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeModal()" class="btn btn-secondary">Close</button>
            <a id="replyLink" href="#" class="btn btn-primary"><i class="fas fa-reply"></i> Reply via Email</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .data-table tr.unread {
        background: #eff6ff;
    }

    .data-table tr.unread td {
        font-weight: 500;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function viewMessage(id, name, email, subject, message, date) {
        document.getElementById('modalName').textContent = name;
        document.getElementById('modalEmail').textContent = email;
        document.getElementById('modalSubject').textContent = subject;
        document.getElementById('modalDate').textContent = date;
        document.getElementById('modalMessage').textContent = message;
        document.getElementById('replyLink').href = 'mailto:' + email + '?subject=Re: ' + encodeURIComponent(subject);
        
        document.getElementById('messageModal').style.display = 'flex';
        
        // Mark as read if not already
        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (row && row.classList.contains('unread')) {
            markAsRead(id);
        }
    }

    function closeModal() {
        document.getElementById('messageModal').style.display = 'none';
    }

    function markAsRead(id) {
        fetch(`/admin/messages/${id}/read`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row) {
                    row.classList.remove('unread');
                    const statusCell = row.querySelector('td:first-child');
                    statusCell.innerHTML = '<span class="status-badge active">Read</span>';
                    
                    // Remove mark as read button
                    const markReadBtn = row.querySelector('.mark-read');
                    if (markReadBtn) {
                        markReadBtn.remove();
                    }
                }
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Handle mark as read buttons
    document.querySelectorAll('.mark-read').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            markAsRead(id);
        });
    });

    // Close modal on overlay click
    document.getElementById('messageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
</script>
{% endblock %}
