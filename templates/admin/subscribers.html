{% extends 'admin/base_admin.html' %}

{% block title %}Subscribers - Admin | InsurancePro{% endblock %}
{% block page_title %}Subscribers{% endblock %}

{% block header_actions %}
<div style="display: flex; gap: 12px;">
    <a href="?status=all" class="btn btn-secondary {% if status == 'all' %}active{% endif %}">All</a>
    <a href="?status=active" class="btn btn-secondary {% if status == 'active' %}active{% endif %}">Active</a>
    <a href="?status=unsubscribed" class="btn btn-secondary {% if status == 'unsubscribed' %}active{% endif %}">Unsubscribed</a>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-users" style="margin-right: 10px;"></i>Subscriber List</h2>
        <div style="display: flex; gap: 12px; align-items: center;">
            <span style="color: var(--text-light); font-size: 14px;">
                Showing {{ subscribers.items|length }} of {{ subscribers.total }} subscribers
            </span>
        </div>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Subscribed</th>
                        <th>Insurance Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for subscriber in subscribers.items %}
                    <tr>
                        <td>#{{ subscriber.id }}</td>
                        <td><strong>{{ subscriber.email }}</strong></td>
                        <td>{{ subscriber.name or '-' }}</td>
                        <td>
                            <span class="status-badge {{ subscriber.status }}">{{ subscriber.status.title() }}</span>
                        </td>
                        <td>{{ subscriber.subscribed_at.strftime('%Y-%m-%d') }}</td>
                        <td>{{ subscriber.insurance_type or '-' }}</td>
                        <td>
                            <div class="table-actions">
                                <button class="action-btn" title="View Details" onclick="viewSubscriber({{ subscriber.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 60px; color: var(--text-light);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            No subscribers found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if subscribers.pages > 1 %}
        <div style="margin-top: 24px; display: flex; justify-content: center; gap: 8px;">
            {% if subscribers.has_prev %}
                <a href="?page={{ subscribers.prev_num }}&status={{ status }}" class="btn btn-secondary">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            {% endif %}
            
            {% for page_num in subscribers.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
                {% if page_num %}
                    {% if page_num == subscribers.page %}
                        <span class="btn btn-primary">{{ page_num }}</span>
                    {% else %}
                        <a href="?page={{ page_num }}&status={{ status }}" class="btn btn-secondary">{{ page_num }}</a>
                    {% endif %}
                {% else %}
                    <span class="btn btn-secondary" disabled>...</span>
                {% endif %}
            {% endfor %}
            
            {% if subscribers.has_next %}
                <a href="?page={{ subscribers.next_num }}&status={{ status }}" class="btn btn-secondary">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Export Section -->
<div class="card" style="margin-top: 24px;">
    <div class="card-header">
        <h2><i class="fas fa-download" style="margin-right: 10px;"></i>Export Data</h2>
    </div>
    <div class="card-body">
        <p style="color: var(--text-light); margin-bottom: 16px;">Download your subscriber list for use in other email marketing tools or for backup purposes.</p>
        <button class="btn btn-primary" onclick="exportSubscribers()">
            <i class="fas fa-file-csv"></i> Export as CSV
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function viewSubscriber(id) {
        // In a real application, this would open a modal with subscriber details
        alert('Subscriber ID: ' + id);
    }

    function exportSubscribers() {
        // Create CSV content
        const rows = [
            ['ID', 'Email', 'Name', 'Status', 'Subscribed Date', 'Insurance Type']
        ];
        
        {% for subscriber in subscribers.items %}
        rows.push([
            '{{ subscriber.id }}',
            '{{ subscriber.email }}',
            '{{ subscriber.name or "" }}',
            '{{ subscriber.status }}',
            '{{ subscriber.subscribed_at.strftime("%Y-%m-%d") }}',
            '{{ subscriber.insurance_type or "" }}'
        ]);
        {% endfor %}
        
        let csvContent = "data:text/csv;charset=utf-8," 
            + rows.map(e => e.join(",")).join("\n");
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "subscribers_{{ status }}.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}
